#!/bin/bash
# nxsp - Helper script to run any tool with Libnexmonkali-Plus
# Usage: 
#   nxsp load              -> Spawns a new shell with library loaded (Default 70ms)
#   nxsp unload            -> Spawns a new shell with library UNLOADED
#   nxsp <delay> <cmd> ... -> Runs specific command with custom delay (0-X ms)

# Locate the library
# 1. Try directory where script is located (Portable/Dev mode)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
if [ -f "$SCRIPT_DIR/libnexmonkali.so" ]; then
    LIBPATH="$SCRIPT_DIR/libnexmonkali.so"
# 2. Try global system library path (Installed mode)
elif [ -f "/usr/lib/libnexmonkali.so" ]; then
    LIBPATH="/usr/lib/libnexmonkali.so"
else
    echo "Error: libnexmonkali.so not found!"
    echo "Checked: $SCRIPT_DIR/libnexmonkali.so"
    echo "Checked: /usr/lib/libnexmonkali.so"
    exit 1
fi

MODE="$1"

if [ "$MODE" == "load" ]; then
    echo "[*] nxsp: Spawning new shell with Libnexmonkali loaded..."
    echo "[*] Default Delay: 70ms (Safe Mode). Use 'export NEXMON_DELAY=0' to override."
    echo "[*] Type 'exit' or use 'nxsp unload' to leave this mode."
    export LD_PRELOAD=$LIBPATH
    # Default to safe mode if not set
    if [ -z "$NEXMON_DELAY" ]; then export NEXMON_DELAY=70000000; fi
    exec $SHELL

elif [ "$MODE" == "unload" ]; then
    echo "[*] nxsp: Spawning new shell WITHOUT Libnexmonkali..."
    unset LD_PRELOAD
    unset NEXMON_DELAY
    exec $SHELL

elif [[ "$MODE" =~ ^[0-9]+$ ]]; then
    # Numeric delay mode
    if [ "$#" -lt 2 ]; then
        echo "Usage: nxsp <delay_ms> <command> [args...]"
        exit 1
    fi
    DELAY_MS=$1
    shift
    export NEXMON_DELAY=$(($DELAY_MS * 1000000))
    # echo "[*] nxsp: Launching '$1' with ${DELAY_MS}ms delay..."
    LD_PRELOAD=$LIBPATH "$@"

else
    echo "Usage:"
    echo "  nxsp load              : Start session with library loaded"
    echo "  nxsp unload            : Start session without library"
    echo "  nxsp <ms> <cmd> [args] : Run command with specific delay ms"
    echo "Example: nxsp 0 reaver -i wlan0 ..."
    exit 1
fi
